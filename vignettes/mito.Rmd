---
title: "Joint single-cell mitochondrial DNA genotyping and DNA accessibility analysis"
author: Caleb Lareau and Tim Stuart
date: 'Compiled: `r format(Sys.Date(), "%B %d, %Y")`'
output: html_document
---

```{r packages, cache=FALSE, message=FALSE, warning = FALSE, echo = TRUE}
library(Signac)
library(Seurat)
library(ggplot2)
library(patchwork)
library(EnsDb.Hsapiens.v75)
```

Here, we profiled a modest number (aimed for ~2,500) cells from a patient with a
colorectal cancer (CRC) tumor.

DNA accessibility data is available on NCBI GEO here: https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE148509

Mitochondrial variant data for each cell is available on XXX here:


## DNA accessibility data import

First we load the scATAC-seq data and create a Seurat object.
  
```{r importData, cache=TRUE, message=FALSE, warning = FALSE, echo = TRUE}
# load counts and metadata from cellranger-atac
counts <- Read10X_h5(filename = "~/data/mito/crc/filtered_peak_bc_matrix.h5")
metadata <- read.csv(
  file = "~/data/mito/crc/singlecell.csv",
  header = TRUE,
  row.names = 1
)

# load annotations
annotations <- GetGRangesFromEnsDb(ensdb = EnsDb.Hsapiens.v75)

# change to UCSC style since the data was mapped to hg19
seqlevelsStyle(annotations) <- 'UCSC'
genome(annotations) <- "hg19"

# create object
crc <- CreateSignacObject(
  counts = counts,
  sep = c(":", "-"),
  assay = 'peaks',
  annotation = annotations,
  min.cells = 10,
  genome = "hg19",
  fragments = '~/data/mito/crc/fragments.tsv.gz',
  meta.data = metadata
)

crc[["peaks"]]
```

## Quality control

```{r message=FALSE, warning=FALSE}
# Augment QC
crc$pct_reads_in_peaks <- crc$peak_region_fragments / crc$passed_filters * 100
crc$pct_reads_in_DNase <- crc$DNase_sensitive_region_fragments / crc$passed_filters * 100
crc$blacklist_ratio <- crc$blacklist_region_fragments / crc$peak_region_fragments

# compute TSS enrichment score and nucleosome banding pattern
crc <- TSSEnrichment(crc)
crc <- NucleosomeSignal(crc)
```


```{r fig.width=12}
VlnPlot(crc, c("TSS.enrichment", "nCount_peaks", "nucleosome_signal", "pct_reads_in_peaks", "pct_reads_in_DNase", "blacklist_ratio"), pt.size = 0, ncol = 6)
```

```{r}
crc$tss.high <- ifelse(crc$TSS.enrichment > 3, "High", "Low")
TSSPlot(crc, group.by = "tss.high")
```

```{r}
crc <- subset(
  x = crc,
  subset = nCount_peaks > 1000 &
    nCount_peaks < 50000 &
    pct_reads_in_DNase > 40 &
    blacklist_ratio < 0.05 &
    TSS.enrichment > 3 & 
    nucleosome_signal < 10
)
crc
```

## Add mtDNA data

```{r process_mito, cache=TRUE, message=FALSE, warning = FALSE, echo = TRUE}
# load mGATK output
mito.data <- ReadMGATK(dir = "~/data/mito/crc/mgatk_inputs/")

# create an assay
mito <- CreateAssayObject(counts = mito.data$counts)

# Subset to cell present in the scATAC-seq assat
mito <- subset(mito, cells = colnames(crc))

# add assay and metadata to the seurat object
crc[["mito"]] <- mito
crc <- AddMetaData(crc, metadata = mito.data$depth, col.name = "mtDNA_depth")

VlnPlot(crc, "mtDNA_depth", pt.size = 0.1) + scale_y_log10()
```

```{r}
# filter cells based on mitochondrial depth
crc <- subset(crc, mtDNA_depth >= 10)
crc
```

## Dimension reduction and clustering

```{r message=FALSE, warning=FALSE}
crc <- RunTFIDF(crc)
crc <- FindTopFeatures(crc, min.cutoff = 10)
crc <- RunSVD(crc)
crc <- RunUMAP(crc, reduction = "lsi", dims = 2:50)
crc <- FindNeighbors(crc, reduction = "lsi", dims = 2:50)
crc <- FindClusters(crc, resolution = 0.5, algorithm = 3)
```

```{r}
DimPlot(crc, label = TRUE) + NoLegend()
```

## Generate gene scores

Here, we can see that some clusters have less mitochondrial DNA content as well
as worse reads in DNase peaks than others. Let's define the cell states using
marker genes to better understand this.

```{r setup_gene_activity, cache=FALSE, message=FALSE, warning = FALSE, echo = TRUE}
# compute gene accessibility
gene.activities <- GeneActivity(crc)

# add to the Seurat object as a new assay
crc[['RNA']] <- CreateAssayObject(counts = gene.activities)

crc <- NormalizeData(
  object = crc,
  assay = 'RNA',
  normalization.method = 'LogNormalize',
  scale.factor = median(crc$nCount_RNA)
)
```

## Visualize interesting gene activity scores

- EPCAM is a marker for epithelial cells
- TREM1 is a meyloid marker
- PTPRC = CD45 = Pan immune cell marker
- IL1RL1 are basophil markers
- GATA3 is a Treg marker
- KIT is a Treg marker


```{r viz_gene_activitites, cache=FALSE, message=FALSE, warning = FALSE, echo = TRUE}
DefaultAssay(crc) <- 'RNA'

FeaturePlot(
  object = crc,
  features = c('TREM1', 'EPCAM', "PTPRC", "IL1RL1","GATA3", "KIT"),
  pt.size = 0.1,
  max.cutoff = 'q95',
  ncol = 2
)
```

Using these gene score values, we can assign cluster identities: 

```
0 - epithelial cells
1 - myeloid 1
2 - basophils
3 - Treg
4 - myeloid 2
5 - mast cells
```

## Look back at QC 

Just to show why we were more inclusive during the cell filtering stage:

```{r other_plots, message=FALSE, warning = FALSE, echo = TRUE}
crc$log10_mtDNA_depth <- log10(crc$mtDNA_depth)
FeaturePlot(crc, features = c("pct_reads_in_DNase", "log10_mtDNA_depth"))
```

Some other views:

```{r cell_filtering_recap, message=FALSE, warning = FALSE, echo = TRUE}
p1 <- FeatureScatter(crc, "mtDNA_depth", "pct_reads_in_peaks") + ggtitle("") + scale_x_log10()
p2 <- FeatureScatter(crc, "mtDNA_depth", "nucleosome_signal") + ggtitle("") + scale_x_log10()

p1 + p2 + plot_layout(guides = 'collect')
```

We can see that most of the low FRIP cells were the `myeloid 1` cluster. This is
some sort of intra-tumor granulocyte that has relatively poor accessible
chromatin enrichment. 

## Find informative mtDNA variants

Next we can identify sites in the mitochondrial genome that vary across cells, 
and cluster the cells into clonotypes based on the frequency of these variants
in the cells.

```{r call_variants, cache=TRUE, message=FALSE, warning = FALSE, echo = TRUE}
variable.sites <- IdentifyVariants(crc, assay = "mito", refallele = mito.data$refallele)

high.conf <- variable.sites[variable.sites$n_cells_conf_detected >= 5, ]

# TODO could add this as a function in Signac
ggplot(high.conf, aes(x = strand_correlation, y = log10(vmr))) +
  geom_point() +
  labs(x = "Pearson correlation (strand)", y = "log VMR") +
  geom_vline(xintercept = 0.65, color = "black", linetype = 2) +
  geom_hline(yintercept = -2, color = "black", linetype = 2) +
  theme_classic()

# Establish a filtered data frame of variants based on this processing
high.conf <- dplyr::filter(high.conf, n_cells_conf_detected >= 5 & strand_correlation >= 0.65 & log10(vmr) > -2)
high.conf
```

Above, the plot is sort of the standard way to visualize potential variants that
could be informative for subclustering. From this execution (which serves as
pretty good defaults from my testing), we get 12 variants. Let's look more
closely:

```{r look_at_variants, cache=TRUE, message=FALSE, warning = FALSE, echo = TRUE}
high.conf[,c(1,2,3,5)]
```

A few things stand out. First, 10 out of the 12 variants occur at less than 1% 
allele frequency in the population. However, 16147C>T is present at about 62%.
We'll see that this is a clonal variant marking the epithelial cells.
Additionally, all of the called variants are transitions. This fits what

## Compute variant allele frequency for each cell

We currently have information for each strand stored in the mito assay to allow
strand concordance to be assessed. Now that we have our set of high-confidence
informative variants, we can create a new assay containing strand-collapsed
allele frequency counts for each cell for these variants using the `AlleleFreq()`
function.

```{r}
crc <- AlleleFreq(
  object = crc,
  variants = high.conf$variant,
  assay = "mito"
)
crc[["alleles"]]
```

## Visualize a subset of the called variants

Currently, this is pretty messy, but I think that visualizing variants on the
reduced dimension embedding is generally useful:

```{r visualize variants, message=FALSE, warning = FALSE, echo = TRUE, fig.height = 8}
DefaultAssay(crc) <- "alleles"
FeaturePlot(
  object = crc,
  features = rownames(crc),
  pt.size = 0.1,
  order = TRUE,
  cols = c("grey", "darkred"),
  ncol = 3,
  max.cutoff = 1
) & NoLegend()
```

Here, we can see a few interesting patterns for the selected variants. 16147C>T
is present in essentially all epithelial cells and almost exclusively in
epithelial cells (the edge cases where this isn't true are also cases where the
UMAP and clustering don't full agree). It is at 100% allele frequency-- strongly
suggestive of whatever cell of origin of this tumor had the mutation at 100% and
then expanded. 

We then see at least 3 variants 9728C>T, 1227G>A, 12889G>A that are mostly
present specifically in the epithelial cells that define subclones. It's not
really enough cells to call subclones unfortunately. 

The variants 824T>C and 3244G>A are found specifically in immune cell
populations, suggesting that these arose from a common hematopoetic progenitor
cell (probably in the bone marrow). 
